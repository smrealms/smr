<?
require_once('SmrMySqlDatabase.class.inc');

require_once('SmrPlayer.class.inc');
class SmrWeapon
{
	protected static $CACHE_WEAPONS = array();
	
	protected static $db;
	
	protected $gameID;
	protected $weaponTypeID;
	protected $name;
	protected $raceID;
	protected $cost;
	protected $shieldDamage;
	protected $armourDamage;
	protected $accuracy;
	protected $powerLevel;
	protected $buyerRestriction;

	
	protected static function initialiseDatabase()
	{
		if(self::$staticDB==null)
			self::$staticDB = new SmrMySqlDatabase();
	}

	public static function &getWeapon($gameID,$weaponTypeID,$forceUpdate = false)
	{
		if($forceUpdate || !isset(self::$CACHE_WEAPONS[$gameID . ':' . $weaponTypeID]))
		{
			$w = new SmrWeapon($gameID,$weaponTypeID);
			return self::$CACHE_WEAPONS[$gameID . ':' . $weaponTypeID] =& $w;
		}
		return self::$CACHE_WEAPONS[$gameID . ':' . $weaponTypeID];
		
	}
	
	protected function __construct($gameID,$weaponTypeID)
	{
		self::initialiseDatabase();
		
		$this->gameID = $gameID;
		$this->weaponTypeID = $weaponTypeID;
			
		self::$staticDB->query('SELECT weapon_name,race_id,cost,shield_damage,armor_damage,accuracy,power_level,buyer_restriction FROM weapon_type WHERE weapon_type_id = ' . $weaponTypeID . ' LIMIT 1');
		
		if(self::$staticDB->nextRecord())
		{
			$this->name = self::$db->getField('weapon_name');
			$this->raceID = (int)self::$db->getField('race_id');
			$this->cost = (int)self::$db->getField('cost');
			$this->shieldDamage = (int)self::$db->getField('shield_damage');
			$this->armourDamage = (int)self::$db->getField('armor_damage');
			$this->accuracy = (int)self::$db->getField('accuracy');
			$this->powerLevel = (int)self::$db->getField('power_level');
			$this->buyerRestriction = (int)self::$db->getField('buyer_restriction');
		}
	}
	
	public function getGeneralModifiedAccuracy(SmrPlayer &$weaponPlayer)
	{
		$modifiedAccuracy = $this->accuracy;
		$modifiedAccuracy += $this->accuracy * ($weaponPlayer->getStat('Accuracy') * ACCURACY_STAT_FACTOR)/100;
		$modifiedAccuracy += $this->accuracy * ($weaponPlayer->getLevelID()*$weaponPlayer->getLevelID()*.008+.219*$weaponPlayer->getLevelID()+1.1694) / 2;
		if ($weaponPlayer->isGadgetEquipped('Increased Accuracy'))
			$modifiedAccuracy += $this->accuracy * INCREASED_ACC_GADGET_FACTOR/100;
		return $modifiedAccuracy;
	}
	
	public function getModifiedAccuracyAgainstPlayer(SmrPlayer &$weaponPlayer, SmrPlayer &$targetPlayer)
	{
		$modifiedAccuracy = $this->getGeneralModifiedAccuracy($weaponPlayer);
		$modifiedAccuracy -= $this->accuracy * ($targetPlayer->getLevelID()*$targetPlayer->getLevelID()*.008+.219*$targetPlayer->getLevelID()+1.1694) / 2;
		if ($targetPlayer->isGadgetEquipped('Increased Maneuverability'))
			$modifiedAccuracy -= $this->accuracy * INCREASED_MAN_GADGET_FACTOR/100;
		
		$weaponShip =& $weaponPlayer->getShip();
		$targetShip =& $targetPlayer->getShip();
		$mrDiff = $targetShip->getMR() - $weaponShip->getMR();
		if($mrDiff > 0)
			$modifiedAccuracy -= $this->accuracy * ($mrDiff/MR_FACTOR)/100;
	
		return $modifiedAccuracy;
	}
	
	
	
//private function get_weapon($weaponPlayer,$weaponShip, $weapon_id, $purpose = 'Normal',$targetPlayer=null,$targetShip=null)
//{
//	//this will be used in the future to display more accurate info for the person using the weapon
//	global $TIME,$GAME_ID, $WEAPONS, $ACCURACY_MOD, $WEAPON_DAMAGE_MOD, $BOMBARDMENT_MOD, $GADGETS, $INCREASED_ACC, $INCREASED_MAN, $INCREASED_DAMAGE_GADGET_VALUE, $WEAPON_RESTRICTIONS,$INCREASED_PLANET_DAMAGE_GADGET_VALUE;
//	
//	//get the weapon restrictions
//	$res_rev = array();
//	foreach ($WEAPON_RESTRICTIONS as $res_id => $res_name) $res_rev[$res_name] = $res_id;
//	
//	//get base weapon
//	$this_weapon = $WEAPONS[$weapon_id];
//	
//	//check for special restrictions/abilities
//	if (in_array($res_rev['Raiding Damage Only'],$this_weapon['Restriction'])) $this_weapon['Raid Only'] = 'TRUE';
//	else $this_weapon['Raid Only'] = 'FALSE';
//	if (in_array($res_rev['May Damage Fleet'],$this_weapon['Restriction'])) $this_weapon['May Damage Fleet'] = 'TRUE';
//	else $this_weapon['May Damage Fleet'] = 'FALSE';
//	
//	//Determine New Damage
//	//do they have the weapon damage gadget?
//	if (gadget_equipped($weaponPlayer,'Increased Weapon Damage'))
//	{
//		$this_weapon['Shield Damage'] *= $INCREASED_DAMAGE_GADGET_VALUE;
//		$this_weapon['Armor Damage'] *= $INCREASED_DAMAGE_GADGET_VALUE;
//	}
//	//do they have the raid damage gadget and are raiding?
//	if (gadget_equipped($weaponPlayer,'Weapon Accelerator') && ($purpose == 'PortRaid' || $purpose == 'PlanetRaid'))
//	{
//		$this_weapon['Shield Damage'] *= $INCREASED_PLANET_DAMAGE_GADGET_VALUE;
//		$this_weapon['Armor Damage'] *= $INCREASED_PLANET_DAMAGE_GADGET_VALUE;
//	}
//	//increase for weapon damage stat
//	$this_weapon['Shield Damage'] *= 1 + ($WEAPON_DAMAGE_MOD * $weaponPlayer->getStat('Weapon Damage')) / 100;
//	$this_weapon['Armor Damage'] *= 1 + ($WEAPON_DAMAGE_MOD * $weaponPlayer->getStat('Weapon Damage')) / 100;
//	//increase for raid damage stat if they are raiding
//	if ($purpose == 'PortRaid' || $purpose == 'PlanetRaid')
//	{
//		$this_weapon['Shield Damage'] *= 1 + ($BOMBARDMENT_MOD * $weaponPlayer->getStat('Bombardment')) / 100;
//		$this_weapon['Armor Damage'] *= 1 + ($BOMBARDMENT_MOD * $weaponPlayer->getStat('Bombardment')) / 100;
//	}
//	//get diminishing returns for attacking
//	$diminishing=1;
//	if($purpose == 'PlanetRaid')
//	{
//		global $REPAIR_BEFORE_DIMINISHING_PLANET_RAID;
//		$diminishing = 1 - ($weaponPlayer->getPastMaint() / $REPAIR_BEFORE_DIMINISHING_PLANET_RAID);
//	}
//	else if($purpose == 'PortRaid')
//	{
//		global $REPAIR_BEFORE_DIMINISHING_PORT_RAID;
//		$diminishing = 1 - ($weaponPlayer->getPastMaint() / $REPAIR_BEFORE_DIMINISHING_PORT_RAID);
//	}
//	else if($purpose == 'Forces')
//	{
//		global $REPAIR_BEFORE_DIMINISHING_FORCE_ATTACK;
//		$diminishing = 1 - ($weaponPlayer->getPastMaint() / $REPAIR_BEFORE_DIMINISHING_FORCE_ATTACK);
//	}
//	else if($purpose == 'Normal')
//	{
//		$REPAIR_BEFORE_DIMINISHING_ATTACK = $weaponShip['Speed'] * 25 + 475;
//		$diminishing = 1 - ($weaponPlayer->getPastMaint() / $REPAIR_BEFORE_DIMINISHING_ATTACK);
//	}
//	if ($diminishing <= 0) $diminishing = 0.00001;
//	$this_weapon['Shield Damage'] = ceil($diminishing * $this_weapon['Shield Damage']);
//	$this_weapon['Armor Damage'] = ceil($diminishing * $this_weapon['Armor Damage']);
//	
//	
//	return $this_weapon;
//}
}

?>